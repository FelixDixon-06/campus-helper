<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campus Helper</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--text2:#cbd5e1;--accent:#22c55e;--accent2:#14b8a6;--danger:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0b1022,#0f172a 30%,#0f172a);color:var(--text)}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    aside{background:rgba(17,24,39,.9);backdrop-filter:saturate(160%) blur(6px);border-right:1px solid #1f2937;padding:18px;position:sticky;top:0;height:100vh}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{height:36px;width:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:grid;place-items:center;font-weight:800;color:#052e2b}
    .brand{font-weight:700;letter-spacing:.3px}
    .sub{color:var(--text2);font-size:12px;margin-top:-6px}
    .nav{display:grid;gap:8px;margin-top:10px}
    .nav button{all:unset;padding:10px 12px;border-radius:12px;cursor:pointer;color:var(--text2);display:flex;align-items:center;gap:10px}
    .nav button.active,.nav button:hover{background:var(--muted);color:var(--text)}
    main{padding:22px 26px}
    .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
    .search{flex:1;min-width:200px}
    input,select,textarea{background:#0b1220;border:1px solid #1f2a44;color:var(--text);padding:10px;border-radius:10px;width:100%}
    input[type=date]{padding:8px}
    textarea{min-height:100px}
    .btn{all:unset;background:linear-gradient(135deg,var(--accent2),var(--accent));padding:10px 14px;border-radius:10px;color:#052e2b;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1f2937;color:var(--text)}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#f97316);color:white}
    .card{background:rgba(17,24,39,.55);border:1px solid #1f2937;border-radius:16px;padding:16px}
    table{width:100%;border-collapse:collapse;background:rgba(15,23,42,.6);border:1px solid #1f2937;border-radius:12px;overflow:hidden}
    th,td{padding:12px;border-bottom:1px solid #1f2937;text-align:left;vertical-align:top}
    th{background:#0b1220;color:#a8b1c6}
    tr:hover td{background:rgba(255,255,255,.02)}
    .pill{padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    .stack{display:grid;gap:8px}
    .muted{color:#94a3b8}
    .section-title{font-size:22px;font-weight:800;margin:8px 0 2px}
    .tiny{font-size:12px;color:#9ca3af}
    dialog{border:none;background:#0b1220;color:var(--text);border:1px solid #1f2937;border-radius:16px;width:min(720px,95vw);padding:0}
    dialog::backdrop{background:rgba(0,0,0,.65)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1f2937}
    .modal-body{padding:16px}
    .modal-foot{display:flex;gap:10px;justify-content:flex-end;padding:14px 16px;border-top:1px solid #1f2937}
    .empty{padding:24px;text-align:center;color:#94a3b8}
    .footer{color:#94a3b8;font-size:12px;margin-top:12px}
    @media(max-width:900px){.app{grid-template-columns:1fr}aside{position:static;height:auto}.brandwrap{display:flex;justify-content:space-between;align-items:center}.nav{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="brandwrap">
        <header>
          <div class="logo">CH</div>
          <div>
            <div class="brand">Campus Helper</div>
            <div class="sub">Student utility portal</div>
          </div>
        </header>
      </div>
      <div class="nav" id="nav"></div>
      <div class="footer tiny">Data is stored locally in your browser (localStorage). Use Export/Import to share with teammates.</div>
    </aside>

    <main>
      <div class="toolbar">
        <input id="globalSearch" class="search" placeholder="Search anything: rooms, teachers, departments, courses‚Ä¶"/>
        <button class="btn secondary" id="exportBtn">Export JSON</button>
        <label class="btn secondary" for="importFile" style="cursor:pointer">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <button class="btn" id="addBtn">Add</button>
      </div>
      <div id="content"></div>
    </main>
  </div>

  <dialog id="modal">
    <form method="dialog">
      <div class="modal-head">
        <div id="modalTitle" style="font-weight:800"></div>
        <button class="btn secondary" onclick="closeModal();return false">Close</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-foot" id="modalFoot"></div>
    </form>
  </dialog>

  <script>
    const DB_KEY = 'campusHelperDB_v1';

    // --- Meta schema for generic CRUD builder
    const meta = {
      departments: {label:'Departments', icon:'üè¢', primary:'name', fields:[
        {key:'name', label:'Department Name', type:'text', required:true}
      ]},
      locations: {label:'Locations', icon:'üìç', primary:'name', fields:[
        {key:'name', label:'Room / Place', type:'text', required:true},
        {key:'type', label:'Type (Room/Lab/Hall/Canteen etc.)', type:'text'}
      ]},
      services: {label:'Services', icon:'üß∞', primary:'name', fields:[
        {key:'name', label:'Service Name', type:'text', required:true},
        {key:'locationId', label:'At Location', type:'ref', ref:'locations'}
      ]},
      faculty: {label:'Faculty', icon:'üë©‚Äçüè´', primary:'name', fields:[
        {key:'name', label:'Name', type:'text', required:true},
        {key:'departmentId', label:'Department', type:'ref', ref:'departments'},
        {key:'locationId', label:'Room / Cabin (Location)', type:'ref', ref:'locations'}
      ]},
      students: {label:'Students', icon:'üë®‚Äçüéì', primary:'name', fields:[
        {key:'name', label:'Name', type:'text', required:true},
        {key:'departmentId', label:'Department', type:'ref', ref:'departments'}
      ]},
      courses: {label:'Courses', icon:'üìò', primary:'name', fields:[
        {key:'name', label:'Course Name', type:'text', required:true},
        {key:'departmentId', label:'Department', type:'ref', ref:'departments'},
        {key:'facultyId', label:'Handled By', type:'ref', ref:'faculty'}
      ]},
      syllabus: {label:'Syllabus', icon:'üóÇÔ∏è', primary:'branch', fields:[
        {key:'branch', label:'Branch', type:'text', required:true},
        {key:'year', label:'Year/Sem', type:'text'},
        {key:'url', label:'Link (Drive/PDF URL)', type:'url'}
      ]},
      notices: {label:'Notices', icon:'üì¢', primary:'title', fields:[
        {key:'title', label:'Title', type:'text', required:true},
        {key:'category', label:'Category', type:'text'},
        {key:'departmentId', label:'Related Department', type:'ref', ref:'departments'}
      ]},
      events: {label:'Events', icon:'üìÖ', primary:'title', fields:[
        {key:'title', label:'Title', type:'text', required:true},
        {key:'date', label:'Date', type:'date'},
        {key:'locationId', label:'At Location', type:'ref', ref:'locations'}
      ]},
      doubts: {label:'Doubts', icon:'‚ùì', primary:'title', fields:[
        {key:'title', label:'Title', type:'text', required:true},
        {key:'studentId', label:'Raised By (Student)', type:'ref', ref:'students'},
        {key:'facultyId', label:'Assigned To (Faculty)', type:'ref', ref:'faculty'},
        {key:'status', label:'Status', type:'select', options:['Open','In Progress','Resolved']}
      ]},
      feedback: {label:'Feedback', icon:'üí¨', primary:'message', fields:[
        {key:'userName', label:'Your Name', type:'text', required:true},
        {key:'userType', label:'You are a‚Ä¶', type:'select', options:['Student','Faculty','Staff','Visitor']},
        {key:'message', label:'Message', type:'textarea', required:true},
        {key:'date', label:'Date', type:'date'}
      ]},
      lostfound: {label:'Lost & Found', icon:'üéí', primary:'title', fields:[
        {key:'title', label:'Item', type:'text', required:true},
        {key:'locationFound', label:'Location Found', type:'ref', ref:'locations'},
        {key:'status', label:'Status', type:'select', options:['Found','Returned']}
      ]}
    };

    // --- Database helpers
    function seed(){
      return {
        nextId: 1000,
        departments:[
          {id:1,name:'CSE'},
          {id:2,name:'ECE'},
          {id:3,name:'MECH'}
        ],
        locations:[
          {id:1,name:'Admin Block ‚Äì 101',type:'Office'},
          {id:2,name:'CSE Block ‚Äì Lab 3',type:'Lab'},
          {id:3,name:'Library ‚Äì Ground Floor',type:'Library'},
          {id:4,name:'Auditorium',type:'Hall'}
        ],
        services:[{id:1,name:'Fees Counter',locationId:1},{id:2,name:'Book Issue',locationId:3}],
        faculty:[
          {id:1,name:'Dr. Asha Rao',departmentId:1,locationId:1},
          {id:2,name:'Prof. Vivek',departmentId:1,locationId:2},
          {id:3,name:'Dr. Neha',departmentId:2,locationId:4}
        ],
        students:[
          {id:1,name:'Anil Kumar',departmentId:1},
          {id:2,name:'Pooja Sharma',departmentId:2}
        ],
        courses:[
          {id:1,name:'DBMS',departmentId:1,facultyId:2},
          {id:2,name:'Signals & Systems',departmentId:2,facultyId:3}
        ],
        syllabus:[{id:1,branch:'CSE',year:'IV Sem',url:''}],
        notices:[{id:1,title:'Midterm schedule released',category:'Exam',departmentId:1}],
        events:[{id:1,title:'Tech Fest',date:new Date().toISOString().slice(0,10),locationId:4}],
        doubts:[{id:1,title:'How to access lab PCs?',studentId:1,facultyId:2,status:'Open'}],
        feedback:[{id:1,userName:'Ravi',userType:'Student',message:'Great portal!',date:new Date().toISOString().slice(0,10)}],
        lostfound:[{id:1,title:'Blue Umbrella',locationFound:3,status:'Found'}]
      };
    }

    function load(){
      const raw = localStorage.getItem(DB_KEY);
      if(!raw){
        const s = seed();
        localStorage.setItem(DB_KEY, JSON.stringify(s));
        return s;
      }
      try{return JSON.parse(raw);}catch(e){
        alert('Corrupt data. Resetting.');
        const s = seed();
        localStorage.setItem(DB_KEY, JSON.stringify(s));
        return s;
      }
    }
    function save(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function nextId(){ return db.nextId++; }

    let db = load();

    // --- UI State
    const sections = Object.keys(meta);
    let current = 'locations';

    // --- Renderers
    function r(str){return str==null?'':String(str)}
    function byId(coll,id){return (db[coll]||[]).find(x=>x.id==id)}
    function labelFor(field,val){
      if(field.type==='ref' && field.ref){
        const t = byId(field.ref, val);
        return t ? (t.name || t.title || t.branch || ('#'+t.id)) : '';
      }
      return r(val);
    }

    function renderNav(){
      const nav = document.getElementById('nav');
      nav.innerHTML = '';
      // Quick Finder entry
      const finderBtn = btn(`üîé Quick Finder`, ()=>openFinder());
      finderBtn.classList.add('active');
      nav.appendChild(finderBtn);
      nav.appendChild(document.createElement('hr'));
      sections.forEach(key=>{
        const b = btn(`${meta[key].icon} ${meta[key].label}`,()=>{current = key; render();});
        b.dataset.key = key;
        nav.appendChild(b);
      });
      highlightActive();
    }

    function highlightActive(){
      document.querySelectorAll('.nav button').forEach(b=>{
        b.classList.remove('active');
        if(b.dataset.key===current) b.classList.add('active');
      })
    }

    function btn(label, on){ const b=document.createElement('button'); b.textContent=label; b.onclick=on; return b; }

    function render(){
      highlightActive();
      const m = meta[current];
      document.getElementById('addBtn').style.display = current? 'inline-block':'none';
      document.getElementById('content').innerHTML = `
        <div class="card">
          <div class="section-title">${m.icon} ${m.label}</div>
          <div id="tableWrap"></div>
        </div>`;
      renderTable();
    }

    function renderTable(){
      const wrap = document.getElementById('tableWrap');
      const m = meta[current];
      const rows = (db[current]||[]).slice();
      const q = document.getElementById('globalSearch').value.trim().toLowerCase();
      const filtered = q ? rows.filter(row => Object.keys(row).some(k => String(row[k]).toLowerCase().includes(q))) : rows;

      if(!filtered.length){ wrap.innerHTML = `<div class='empty'>No records. Click ‚ÄúAdd‚Äù to create one.</div>`; return; }

      const cols = ['id', ...m.fields.map(f=>f.key)];
      const thead = `<thead><tr>${cols.map(c=>`<th>${(m.fields.find(f=>f.key===c)||{label:c}).label||c}</th>`).join('')}<th>Actions</th></tr></thead>`;
      const tbody = `<tbody>${filtered.map(row=>{
        const cells = cols.map(c=>{
          const f = m.fields.find(x=>x.key===c);
          const v = f? labelFor(f,row[c]) : r(row[c]);
          return `<td>${v || '<span class="tiny muted">‚Äî</span>'}</td>`
        }).join('');
        return `<tr>${cells}<td>
          <span class='pill tiny'>#${row.id}</span>
          <button class='btn secondary' onclick='openForm("${current}", ${row.id})'>Edit</button>
          <button class='btn danger' onclick='delRecord("${current}", ${row.id})'>Delete</button>
        </td></tr>`;
      }).join('')}</tbody>`;
      wrap.innerHTML = `<div style='overflow:auto'><table>${thead}${tbody}</table></div>`;
    }

    // --- Forms
    function openForm(coll, id){
      const m = meta[coll];
      const isNew = !id;
      const row = isNew ? {} : db[coll].find(x=>x.id===id) || {};
      const body = document.getElementById('modalBody');
      body.innerHTML = '';

      const form = document.createElement('div');
      form.className = 'grid two';
      m.fields.forEach(f=>{
        const box = document.createElement('div');
        box.className='stack';
        const label = document.createElement('label');
        label.textContent = f.label;
        let input;
        if(f.type==='textarea'){
          input=document.createElement('textarea');
        } else if(f.type==='select'){
          input=document.createElement('select');
          (f.options||[]).forEach(op=>{const o=document.createElement('option');o.value=op;o.textContent=op;input.appendChild(o);});
        } else if(f.type==='ref'){
          input=document.createElement('select');
          const none=document.createElement('option'); none.value=''; none.textContent='‚Äî'; input.appendChild(none);
          (db[f.ref]||[]).forEach(op=>{const o=document.createElement('option');o.value=op.id;o.textContent=(op.name||op.title||op.branch||('#'+op.id));input.appendChild(o);});
        } else {
          input=document.createElement('input');
          input.type = f.type||'text';
        }
        input.id = `f_${f.key}`;
        if(row[f.key]!=null) input.value = row[f.key];
        if(f.required) input.required = true;
        box.appendChild(label); box.appendChild(input); form.appendChild(box);
      });

      body.appendChild(form);

      document.getElementById('modalTitle').textContent = `${isNew?'Add':'Edit'} ${m.label.slice(0,-1)}`;
      const foot = document.getElementById('modalFoot');
      foot.innerHTML = '';
      const saveBtn = document.createElement('button');
      saveBtn.className='btn'; saveBtn.textContent='Save';
      saveBtn.onclick = () => {
        const obj = isNew ? {id: nextId()} : {...row};
        m.fields.forEach(f=>{
          const el = document.getElementById(`f_${f.key}`);
          if(f.type==='ref') obj[f.key] = el.value? Number(el.value):'';
          else obj[f.key] = el.value;
        });
        if(isNew) db[coll].push(obj); else db[coll] = db[coll].map(x=>x.id===id?obj:x);
        save(); closeModal(); renderTable();
      };
      const cancelBtn = document.createElement('button'); cancelBtn.className='btn secondary'; cancelBtn.textContent='Cancel'; cancelBtn.onclick=()=>{closeModal()};
      foot.appendChild(cancelBtn); foot.appendChild(saveBtn);
      openModal();
    }

    function delRecord(coll,id){
      if(!confirm('Delete this record?')) return;
      db[coll] = (db[coll]||[]).filter(x=>x.id!==id);
      save(); renderTable();
    }

    // --- Finder
    function openFinder(){
      document.getElementById('addBtn').style.display='none';
      const c = document.getElementById('content');
      c.innerHTML = `
        <div class='grid two'>
          <div class='card'>
            <div class='section-title'>üîé Quick Finder</div>
            <div class='stack'>
              <input id='finderQuery' placeholder='Try "Vivek", "Lab 3", "CSE", "Fees Counter"‚Ä¶' oninput='doFind()' />
              <div class='tiny muted'>Find teachers, rooms, departments, services, courses, events and more.</div>
            </div>
            <div id='finderResults' style='margin-top:12px'></div>
          </div>
          <div class='card'>
            <div class='section-title'>üìÖ Today on Campus</div>
            <div id='todayBox'></div>
          </div>
        </div>`;
      doFind();
      renderToday();
    }

    function doFind(){
      const q = (document.getElementById('finderQuery')?.value||'').toLowerCase().trim();
      const out = document.getElementById('finderResults');
      const buckets = [];
      const push = (title, rows, fmt) => { if(!rows.length) return; buckets.push(`<div class='stack'><div class='section-title tiny' style='opacity:.6'>${title}</div>${rows.map(fmt).join('')}</div>`)}

      // Faculty
      const fac = db.faculty.filter(x=>!q || Object.values(x).join(' ').toLowerCase().includes(q));
      push('Faculty', fac.slice(0,10), f=>{
        const dept = byId('departments',f.departmentId); const loc = byId('locations',f.locationId);
        return `<div class='card'><b>${f.name}</b><div class='tiny muted'>${dept?dept.name:''}${dept&&loc?' ‚Ä¢ ':''}${loc?loc.name:''}</div></div>`
      });

      // Locations
      const locs = db.locations.filter(x=>!q || Object.values(x).join(' ').toLowerCase().includes(q));
      push('Locations', locs.slice(0,10), l=>`<div class='card'><b>${l.name}</b><div class='tiny muted'>${l.type||''}</div></div>`);

      // Services
      const srvs = db.services.filter(x=>!q || Object.values(x).join(' ').toLowerCase().includes(q));
      push('Services', srvs.slice(0,10), s=>`<div class='card'><b>${s.name}</b><div class='tiny muted'>${byId('locations',s.locationId)?.name||''}</div></div>`);

      // Departments
      const deps = db.departments.filter(x=>!q || Object.values(x).join(' ').toLowerCase().includes(q));
      push('Departments', deps.slice(0,10), d=>`<div class='card'><b>${d.name}</b></div>`);

      // Courses
      const crs = db.courses.filter(x=>!q || Object.values(x).join(' ').toLowerCase().includes(q));
      push('Courses', crs.slice(0,10), r=>`<div class='card'><b>${r.name}</b><div class='tiny muted'>${byId('departments',r.departmentId)?.name||''} ‚Ä¢ ${byId('faculty',r.facultyId)?.name||''}</div></div>`);

      // Events today or matching
      const ev = db.events.filter(x=>!q || Object.values(x).join(' ').toLowerCase().includes(q));
      push('Events', ev.slice(0,10), e=>`<div class='card'><b>${e.title}</b><div class='tiny muted'>${e.date||''} ‚Ä¢ ${byId('locations',e.locationId)?.name||''}</div></div>`);

      // Lost & Found
      const lf = db.lostfound.filter(x=>!q || Object.values(x).join(' ').toLowerCase().includes(q));
      push('Lost & Found', lf.slice(0,10), i=>`<div class='card'><b>${i.title}</b><div class='tiny muted'>${byId('locations',i.locationFound)?.name||''} ‚Ä¢ ${i.status}</div></div>`);

      out.innerHTML = buckets.join('') || `<div class='empty'>No matches yet. Try another keyword.</div>`;
    }

    function renderToday(){
      const box = document.getElementById('todayBox'); if(!box) return;
      const today = new Date().toISOString().slice(0,10);
      const ev = db.events.filter(e=>e.date===today);
      if(!ev.length){ box.innerHTML = `<div class='empty'>No events today.</div>`; return; }
      box.innerHTML = ev.map(e=>`<div class='card'><b>${e.title}</b><div class='tiny muted'>${byId('locations',e.locationId)?.name||''}</div></div>`).join('');
    }

    // --- Modal helpers
    const modal = document.getElementById('modal');
    function openModal(){ modal.showModal(); }
    function closeModal(){ modal.close(); }

    // --- Global toolbar actions
    document.getElementById('globalSearch').addEventListener('input',()=>{
      if(document.querySelector('#tableWrap')) renderTable(); else doFind();
    });
    document.getElementById('addBtn').onclick = ()=> openForm(current, null);

    document.getElementById('exportBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='campus-helper-data.json'; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById('importFile').onchange = (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const fr = new FileReader(); fr.onload = ()=>{
        try{ db = JSON.parse(fr.result); save(); alert('Import successful'); render(); }
        catch(err){ alert('Invalid JSON'); }
      }; fr.readAsText(file);
    };

    // initial
    renderNav();
    openFinder();
  </script>
</body>
</html>
